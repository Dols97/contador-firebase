<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contador compartido</title>
</head>
<body>

<h1 id="contador">—</h1>
<button id="btn">Obtener número</button>
<pre id="estado" style="white-space:pre-wrap;"></pre>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC8b_vVtpAaCoqf7sopWIPD4Ubr9CdHnQc",
    authDomain: "contador-2036b.firebaseapp.com",
    projectId: "contador-2036b",
    storageBucket: "contador-2036b.firebasestorage.app",
    messagingSenderId: "306453517182",
    appId: "1:306453517182:web:b02fa2edd7dc30b691192f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const contadorEl = document.getElementById("contador");
  const estadoEl = document.getElementById("estado");

  function formatear4(n) {
    return String(n).padStart(6, "0");
  }

  document.getElementById("btn").addEventListener("click", async () => {
    contadorEl.textContent = "…";
    estadoEl.textContent = "Pidiendo número...";

    try {
      const ref = doc(db, "contador", "global");

      const info = await runTransaction(db, async (tx) => {
        const snap = await tx.get(ref);

        const existe = snap.exists();
        const data = existe ? snap.data() : {};
        const anterior = (typeof data.valor === "number") ? data.valor : 0;

        const nuevo = anterior + 1;
        tx.set(ref, { valor: nuevo }, { merge: true });

        return { existe, anterior, nuevo };
      });

      // Solo mostramos el número asignado (formateado)
      contadorEl.textContent = formatear4(info.nuevo);

      // Logs detallados
      estadoEl.textContent =
        `Doc existe: ${info.existe}\n` +
        `Valor anterior: ${info.anterior}\n` +
        `Nuevo valor: ${info.nuevo}\n` +
        `Mostrado: ${formatear4(info.nuevo)}\n`;
    } catch (e) {
      contadorEl.textContent = "N/A";
      estadoEl.textContent = "ERROR ❌ " + (e?.message || e);
      console.error("FIREBASE ERROR:", e);
    }
  });
</script>

</body>
</html>

