<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contador compartido</title>
</head>
<body>

<h1 id="contador">0</h1>
<button id="btn">Obtener número</button>
<pre id="estado" style="white-space:pre-wrap;"></pre>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC8b_vVtpAaCoqf7sopWIPD4Ubr9CdHnQc",
    authDomain: "contador-2036b.firebaseapp.com",
    projectId: "contador-2036b",
    storageBucket: "contador-2036b.firebasestorage.app",
    messagingSenderId: "306453517182",
    appId: "1:306453517182:web:b02fa2edd7dc30b691192f",
    measurementId: "G-15ZK3W7CLT"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const contadorEl = document.getElementById("contador");
  const estadoEl = document.getElementById("estado");

  document.getElementById("btn").addEventListener("click", async () => {
    estadoEl.textContent = "Pidiendo número...";
    try {
      const ref = doc(db, "contador", "global");

      const nuevo = await runTransaction(db, async (tx) => {
        const snap = await tx.get(ref);

        let valorActual = 0;
        if (snap.exists()) {
          const data = snap.data();
          valorActual = (typeof data.valor === "number") ? data.valor : 0;
        }

        const siguiente = valorActual + 1;
        tx.set(ref, { valor: siguiente }, { merge: true });

        return { valorActual, siguiente, existe: snap.exists() };
      });

      contadorEl.textContent = String(nuevo.siguiente);
      estadoEl.textContent =
        `Doc existe: ${nuevo.existe}\n` +
        `Valor leído: ${nuevo.valorActual}\n` +
        `Nuevo valor: ${nuevo.siguiente}\n`;
    } catch (e) {
      contadorEl.textContent = "N/A";
      estadoEl.textContent = "ERROR ❌ " + (e?.message || e);
      console.error(e);
    }
  });
</script>

</body>
</html>
